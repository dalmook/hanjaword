<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>중국어 단어장 · 모바일</title>
  <meta name="description" content="한자·병음·뜻·품사·예문·발음(TTS)까지 지원하는 카드형 중국어 단어장" />
  <style>
    /* 기존 스타일 유지 */
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,sans-serif;background:#0b1020;color:#e6eefc}
    .wrap{max-width:820px;margin:0 auto;padding:16px 16px 96px}
    .btn{cursor:pointer;padding:8px 12px;border-radius:12px;border:1px solid #26325a;background:#1b2544;color:#e6eefc}
    .btn.acc{background:#4da3ff;color:#081123}
    .card{background:#12182b;padding:20px;border-radius:18px;min-height:220px;margin-top:14px}
    .hanzi{font-size:44px}
    .pinyin{font-size:18px;color:#cbd5e1;margin-top:6px}
    .meaning{margin-top:6px;font-size:16px}
    .example{margin-top:10px;font-size:15px}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>중국어 단어장</h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <input id="search" placeholder="검색 (한자/뜻)" />
      <select id="filterPos">
        <option value="">품사 전체</option>
        <option>명사</option>
        <option>동사</option>
        <option>형용사</option>
      </select>
      <select id="filterChap">
        <option value="">모든 챕터</option>
      </select>
      <button class="btn acc" id="addBtn">추가</button>
      <button class="btn" id="quizBtn">퀴즈</button>
      <button class="btn" id="syncBtn">구글 시트 동기화</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card" id="card">
      <div class="hanzi" id="hanzi">단어를 불러오세요</div>
      <div class="pinyin" id="pinyin"></div>
      <div class="meaning" id="meaning"></div>
      <div class="example" id="example"></div>
    </section>
    <div style="margin-top:10px">
      <button class="btn" id="prevBtn">이전</button>
      <button class="btn" id="nextBtn">다음</button>
    </div>
  </main>

  <!-- 퀴즈 모달 -->
  <dialog id="quizModal">
    <div style="padding:16px">
      <h3>퀴즈 모드</h3>
      <p id="quizQuestion"></p>
      <div id="mcOptions" class="mc"></div>
      <div style="margin-top:10px">
        <button class="btn acc" id="quizNext">다음 문제</button>
        <button class="btn" onclick="quizModal.close()">닫기</button>
      </div>
      <p id="quizFeedback"></p>
    </div>
  </dialog>

  <script>
    const LS_KEY = 'cn_vocab_cards_v2';
    let cards = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
    let cursor=0;
    let quizMode = null; // 'hanzi2meaning' or 'meaning2hanzi'
    let quizCorrect = ''; // 객관식 정답 보관

    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(cards)); }
    function current(){ return cards[cursor]||null; }
    function render(){
      const c = current();
      if(!c){ hanzi.textContent='단어 없음'; pinyin.textContent=''; meaning.textContent=''; example.textContent=''; return; }
      hanzi.textContent=c.hanzi;
      pinyin.textContent=c.pinyin;
      meaning.textContent=c.meaning;
      example.textContent=c.example?`${c.example} (${c.example_ko||''})`:'';
    }
    function next(){ cursor=(cursor+1)%cards.length; render(); }
    function prev(){ cursor=(cursor-1+cards.length)%cards.length; render(); }

    // 구글 시트 동기화 (Apps Script Web App 엔드포인트 필요)
    async function sync(){
      const url = prompt('https://script.google.com/macros/s/AKfycbwpY0YKjzzr2KIfWIi8bcdNR4eJqyk8Hr2cRY4tt2MuIv8syI_wStRpnry0JVCwHp8f/exec');
      if(!url) return;
      try{
        const res = await fetch(url);
        const data = await res.json();
        if(Array.isArray(data)){
          cards = data;
          save();
          cursor=0; render();
          alert('동기화 완료');
        }
      }catch(e){ alert('동기화 실패:'+e); }
    }

    // 챕터 필터링
    function updateChapters(){
      const chapSel=document.getElementById('filterChap');
      const chaps=[...new Set(cards.map(c=>c.chapter).filter(Boolean))];
      chapSel.innerHTML='<option value="">모든 챕터</option>'+chaps.map(c=>`<option>${c}</option>`).join('');
    }

    // 퀴즈 모드
    function startQuiz(){
      quizMode = confirm('한자→뜻 4지선다로 하시겠습니까? (취소=뜻→한자)') ? 'hanzi2meaning' : 'meaning2hanzi';
      nextQuiz();
      quizModal.showModal();
    }
    function nextQuiz(){
      const c = current(); if(!c) return;
      const fieldA = (quizMode==='hanzi2meaning') ? 'meaning' : 'hanzi';
      quizQuestion.textContent = (quizMode==='hanzi2meaning') ? '이 단어의 뜻은 무엇일까요? → ' + c.hanzi : '이 뜻에 해당하는 한자는 무엇일까요? → ' + c.meaning;
      // 정답
      quizCorrect = c[fieldA] || '';
      // 보기 생성
      const pool = cards.filter((x,i)=>i!==cursor).map(x=>x[fieldA]).filter(Boolean);
      for(let i=pool.length-1;i>0;i--){ const j=(Math.random()*(i+1)|0); const tmp=pool[i]; pool[i]=pool[j]; pool[j]=tmp; }
      const optsSet = new Set([quizCorrect]);
      for(const v of pool){ if(optsSet.size>=4) break; if(v!==quizCorrect) optsSet.add(v); }
      const opts = Array.from(optsSet);
      for(let i=opts.length-1;i>0;i--){ const j=(Math.random()*(i+1)|0); const t=opts[i]; opts[i]=opts[j]; opts[j]=t; }
      const cont = document.getElementById('mcOptions');
      cont.innerHTML = '';
      opts.forEach(t=>{
        const b=document.createElement('button');
        b.className='btn';
        b.textContent=t;
        b.style.margin='6px 6px 0 0';
        b.onclick=()=>{
          const ok = stripSpaces(t)===stripSpaces(quizCorrect);
          document.getElementById('quizFeedback').textContent = ok ? '✅ 정답!' : ('❌ 오답. 정답: '+quizCorrect);
        };
        cont.appendChild(b);
      });
      document.getElementById('quizFeedback').textContent='';
    }
    function stripSpaces(s){ return (s||'').split(' ').join(''); }`;
      }else{
        quizQuestion.textContent=`이 뜻에 해당하는 한자는 무엇일까요? → ${c.meaning}`;
      }
      quizAnswer.value='';
      quizFeedback.textContent='';
    }
    function checkQuiz(){ /* 주관식 모드 제거됨: 객관식 4지선다 사용 */ }

    document.getElementById('nextBtn').onclick=next;
    document.getElementById('prevBtn').onclick=prev;
    document.getElementById('syncBtn').onclick=sync;
    document.getElementById('quizBtn').onclick=startQuiz;
    document.getElementById('quizNext').onclick=()=>{ next(); nextQuiz(); };

    render();
  </script>
</body>
</html>
