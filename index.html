<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ì¤‘êµ­ì–´ ë‹¨ì–´ì¥ Â· ëª¨ë°”ì¼</title>
  <meta name="description" content="í•œìÂ·ë³‘ìŒÂ·ëœ»Â·í’ˆì‚¬Â·ì±•í„°Â·ì˜ˆë¬¸ + 4ì§€ì„ ë‹¤ í€´ì¦ˆ + êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ + ìŒì„± ë°œìŒ" />
  <style>
    :root{
      --bg:#0b1020; --bg2:#0a0f23; --panel:#0f1530; --panel2:#121a3a; --accent:#4da3ff; --text:#e6eefc; --muted:#9fb3d7; --ok:#22c55e; --danger:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2) 50%,var(--bg));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:16px 16px 120px}
    header{position:sticky;top:0;background:rgba(10,15,35,.75);backdrop-filter:blur(10px);border-bottom:1px solid #1f2b52;z-index:10}
    header h1{font-size:18px;margin:0 0 8px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    input,select{background:#0e1430;border:1px solid #2a3a6c;color:var(--text);padding:10px 12px;border-radius:12px;min-width:130px}
    .btn{background:#1b254a;border:1px solid #2b3a6f;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);transition:transform .08s ease}
    .btn:active{transform:translateY(1px)}
    .btn.acc{background:var(--accent);border-color:#5fb0ff;color:#081123}

    /* Card */
    .card{position:relative;margin-top:14px;background:radial-gradient(120% 120% at 0% 0%,#162047,var(--panel));border:1px solid #27345f;border-radius:var(--r);padding:20px;min-height:260px;box-shadow:var(--shadow)}
    .hanzi{font-size:48px;letter-spacing:.4px}
    .pinyin{font-size:18px;color:#cbd5e1;margin-top:6px}
    .meaning{margin-top:10px;font-size:18px;user-select:none;cursor:pointer}
    .meaning.masked{color:var(--muted);opacity:.95}
    .example{margin-top:12px;border-top:1px dashed #2a3a6c;padding-top:10px;color:#d6e1ff}
    .actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}

    /* Quiz */
    dialog{border:none;border-radius:16px;background:#0b142f;color:var(--text)}
    #mcOptions{display:grid;grid-template-columns:1fr;gap:8px}

    /* Bottom nav on mobile */
    .bottom-bar{position:fixed;left:0;right:0;bottom:0;background:rgba(10,15,35,.85);backdrop-filter:blur(10px);border-top:1px solid #1f2b52;display:flex;gap:8px;padding:10px;justify-content:center}
    .bottom-bar .btn{min-width:110px}

    @media(min-width:700px){ #mcOptions{grid-template-columns:1fr 1fr} }
    @media(max-width:420px){ .hanzi{font-size:42px} }
  </style>
</head>
<body>
  <header class="wrap">
    <h1>ì¤‘êµ­ì–´ ë‹¨ì–´ì¥</h1>
    <div class="toolbar">
      <input id="search" placeholder="ê²€ìƒ‰ (í•œì/ëœ»/ì˜ˆë¬¸)" />
      <select id="filterPos"><option value="">í’ˆì‚¬ ì „ì²´</option><option>ëª…ì‚¬</option><option>ë™ì‚¬</option><option>í˜•ìš©ì‚¬</option></select>
      <select id="filterChap"><option value="">ëª¨ë“  ì±•í„°</option></select>
      <button class="btn acc" id="addBtn">ì¶”ê°€</button>
      <button class="btn" id="quizBtn">í€´ì¦ˆ</button>
      <button class="btn" id="syncBtn">êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™”</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card" id="card">
      <div class="hanzi" id="hanzi">ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”</div>
      <div class="pinyin" id="pinyin"></div>
      <div class="meaning" id="meaning"></div>
      <div class="example" id="example"></div>
      <div class="actions">
        <button class="btn" id="speakWord">ğŸ”Š ë‹¨ì–´ ë°œìŒ</button>
        <button class="btn" id="speakExample">ğŸ§ ì˜ˆë¬¸ ë°œìŒ</button>
      </div>
    </section>
  </main>

  <!-- í•˜ë‹¨ ê³ ì • ë‚´ë¹„ê²Œì´ì…˜ -->
  <div class="bottom-bar">
    <button class="btn" id="prevBtn">âŸµ ì´ì „</button>
    <button class="btn" id="nextBtn">ë‹¤ìŒ âŸ¶</button>
  </div>

  <!-- í€´ì¦ˆ ëª¨ë“œ -->
  <dialog id="quizModeModal">
    <div style="padding:16px">
      <h3>í€´ì¦ˆ ëª¨ë“œ ì„ íƒ</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn acc" id="modeH2M">í•œì â†’ ëœ»</button>
        <button class="btn" id="modeM2H">ëœ» â†’ í•œì</button>
      </div>
      <div style="margin-top:12px"><button class="btn" onclick="quizModeModal.close()">ë‹«ê¸°</button></div>
    </div>
  </dialog>

  <dialog id="quizModal">
    <div style="padding:16px;max-width:720px;width:92vw">
      <h3>í€´ì¦ˆ</h3>
      <p id="quizQ"></p>
      <div id="mcOptions"></div>
      <p id="quizFeedback" style="margin:6px 0 10px;color:#9fb3d7"></p>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="quizNext">ë‹¤ìŒ</button>
        <button class="btn" onclick="quizModal.close()">ë‹«ê¸°</button>
      </div>
    </div>
  </dialog>

  <script>
    // 1) êµ¬ê¸€ ì‹œíŠ¸ ì›¹ì•± URL (ê³ ì • ì„¤ì •)
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbwpY0YKjzzr2KIfWIi8bcdNR4eJqyk8Hr2cRY4tt2MuIv8syI_wStRpnry0JVCwHp8f/exec";

    // 2) ìƒíƒœ
    const LS_KEY = 'cn_vocab_cards_v5';
    let cards = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
    let cursor=0; let quizMode=null; let quizCorrect='';

    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(cards)); }
    function current(){ return cards[cursor]||null; }

    // 3) ë Œë” (ëœ»ì€ ê¸°ë³¸ ë¹„ê³µê°œ â†’ íƒ­ ì‹œ ê³µê°œ)
    function render(){
      const c=current();
      if(!c){ hanzi.textContent='ë‹¨ì–´ ì—†ìŒ'; pinyin.textContent=''; meaning.textContent=''; example.textContent=''; return; }
      hanzi.textContent=c.hanzi||''; pinyin.textContent=c.pinyin||'';
      meaning.dataset.value = c.meaning || '';
      meaning.classList.add('masked');
      meaning.textContent = meaning.dataset.value ? 'íƒ­í•˜ì—¬ ëœ» ë³´ê¸°' : '';
      example.textContent=c.example ? (c.example + (c.example_ko ? " ("+c.example_ko+")" : "")) : '';
    }

    // 4) ê²€ìƒ‰/í•„í„° (ê°„ë‹¨í˜•; í•„ìš” ì‹œ í™•ì¥ ê°€ëŠ¥)
    search.oninput = ()=>applyFilter();
    filterPos.onchange = ()=>applyFilter();
    filterChap.onchange = ()=>applyFilter();
    function applyFilter(){ /* í•„ìš” ì‹œ í™•ì¥: ì§€ê¸ˆì€ ì „ì²´ cards ì‚¬ìš© */ }

    // 5) ì´ë™
    function next(){ if(!cards.length) return; cursor=(cursor+1)%cards.length; render(); }
    function prev(){ if(!cards.length) return; cursor=(cursor-1+cards.length)%cards.length; render(); }

    // 6) ì‹œíŠ¸ ë™ê¸°í™”
    async function sync(){
      try{
        const res = await fetch(SHEET_URL+"?action=read");
        const js = await res.json();
        const data = Array.isArray(js)? js : (js&&js.data?js.data:[]);
        if(Array.isArray(data)){ cards=data; save(); cursor=0; render(); alert("ë™ê¸°í™” ì™„ë£Œ: "+cards.length+"ê°œ"); }
        else alert("ì‹œíŠ¸ ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜");
      }catch(e){ alert("ë™ê¸°í™” ì‹¤íŒ¨: "+e); }
    }

    // 7) í€´ì¦ˆ
    function startQuiz(){ quizModeModal.showModal(); }
    function nextQuiz(){
      const c=current(); if(!c) return;
      if(quizMode==='hanzi2meaning'){
        quizQ.textContent=`ëœ»ì€ ë¬´ì—‡ì¼ê¹Œìš”? â†’ ${c.hanzi}`;
        quizCorrect=c.meaning||'';
        makeOptions('meaning');
      }else{
        quizQ.textContent=`í•œìëŠ” ë¬´ì—‡ì¼ê¹Œìš”? â†’ ${c.meaning}`;
        quizCorrect=c.hanzi||'';
        makeOptions('hanzi');
      }
    }
    function makeOptions(field){
      const pool = cards.map(x=>x[field]).filter(Boolean);
      for(let i=pool.length-1;i>0;i--){const j=(Math.random()*(i+1)|0);[pool[i],pool[j]]=[pool[j],pool[i]];}
      const opts=new Set([quizCorrect]);
      for(const v of pool){ if(opts.size>=4) break; if(v!==quizCorrect) opts.add(v);} 
      const arr=[...opts];
      for(let i=arr.length-1;i>0;i--){const j=(Math.random()*(i+1)|0);[arr[i],arr[j]]=[arr[j],arr[i]];}
      mcOptions.innerHTML='';
      arr.forEach(t=>{
        const b=document.createElement('button');b.className='btn';b.textContent=t;
        b.onclick=()=>{ const ok=(t===quizCorrect); quizFeedback.textContent=(ok?'âœ… ì •ë‹µ':'âŒ ì •ë‹µ: '+quizCorrect); if(ok) playDing(); };
        mcOptions.appendChild(b);
      });
    }

    // 8) ìŒì„± í•©ì„±(TTS)
    function speakZh(text){
      if(!('speechSynthesis' in window) || !text) return;
      const u=new SpeechSynthesisUtterance(text);
      u.lang='zh-CN'; u.rate=1; u.pitch=1;
      try{ speechSynthesis.cancel(); setTimeout(()=>speechSynthesis.speak(u),0); }catch(e){}
    }

    // 9) ì •ë‹µ íš¨ê³¼ìŒ (Web Audioë¡œ â€˜ëµë™â€™)
    function playDing(){
      const AC = window.AudioContext||window.webkitAudioContext; if(!AC) return; const ctx=new AC();
      const now=ctx.currentTime;
      const o1=ctx.createOscillator(), g1=ctx.createGain(); o1.type='sine'; o1.frequency.setValueAtTime(880, now);
      g1.gain.setValueAtTime(0.0001, now); g1.gain.exponentialRampToValueAtTime(0.25, now+0.01); g1.gain.exponentialRampToValueAtTime(0.0001, now+0.23);
      o1.connect(g1).connect(ctx.destination); o1.start(now); o1.stop(now+0.24);
      const o2=ctx.createOscillator(), g2=ctx.createGain(); o2.type='sine'; o2.frequency.setValueAtTime(660, now+0.26);
      g2.gain.setValueAtTime(0.0001, now+0.26); g2.gain.exponentialRampToValueAtTime(0.22, now+0.27); g2.gain.exponentialRampToValueAtTime(0.0001, now+0.52);
      o2.connect(g2).connect(ctx.destination); o2.start(now+0.26); o2.stop(now+0.53);
    }

    // 10) ëœ» í† ê¸€(íƒ­í•˜ì—¬ ë³´ê¸°)
    document.getElementById('meaning').addEventListener('click',()=>{
      const el = document.getElementById('meaning');
      const val = el.dataset.value||''; if(!val) return;
      if(el.classList.contains('masked')){ el.classList.remove('masked'); el.textContent=val; }
      else { el.classList.add('masked'); el.textContent='íƒ­í•˜ì—¬ ëœ» ë³´ê¸°'; }
    });

    // 11) ë²„íŠ¼/ì´ë²¤íŠ¸
    document.getElementById('speakWord').onclick=()=>{const c=current(); if(c) speakZh(c.hanzi);};
    document.getElementById('speakExample').onclick=()=>{const c=current(); if(c) speakZh(c.example||c.hanzi);};
    document.getElementById('nextBtn').onclick=()=>{ next(); };
    document.getElementById('prevBtn').onclick=()=>{ prev(); };
    document.getElementById('syncBtn').onclick=sync;
    document.getElementById('quizBtn').onclick=startQuiz;
    document.getElementById('quizNext').onclick=()=>{ next(); nextQuiz(); };
    document.getElementById('modeH2M').onclick=()=>{quizMode='hanzi2meaning'; nextQuiz(); quizModeModal.close(); quizModal.showModal();};
    document.getElementById('modeM2H').onclick=()=>{quizMode='meaning2hanzi'; nextQuiz(); quizModeModal.close(); quizModal.showModal();};

    // 12) ì´ˆê¸° ë Œë”
    render();
  </script>

  <!-- Apps Script ì˜ˆì‹œ
  function doGet(e){
    const sheet=SpreadsheetApp.getActive().getSheets()[0];
    const rows=sheet.getDataRange().getValues(); rows.shift();
    const items=rows.map(r=>({hanzi:r[0],pinyin:r[1],meaning:r[2],pos:r[3],example:r[4],example_ko:r[5],chapter:r[6]}));
    return ContentService.createTextOutput(JSON.stringify(items)).setMimeType(ContentService.MimeType.JSON);
  }
  -->
</body>
</html>
