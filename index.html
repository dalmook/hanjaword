<!doctype html>

<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ì¤‘êµ­ì–´ ë‹¨ì–´ì¥ Â· ëª¨ë°”ì¼</title>
  <meta name="description" content="í•œìÂ·ë³‘ìŒÂ·ëœ»Â·í’ˆì‚¬Â·ì±•í„°Â·ì˜ˆë¬¸ + 4ì§€ì„ ë‹¤ í€´ì¦ˆ + êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ + ì¤‘êµ­ì–´ TTS" />
  <style>
    :root{ --bg:#0b1020; --panel:#12182b; --accent:#4da3ff; --muted:#94a3b8; --text:#e6eefc; --ok:#22c55e; --danger:#ef4444; --radius:18px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f23 50%,#0b1020);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:16px 16px 112px}
    header{position:sticky;top:0;background:rgba(11,16,32,.85);backdrop-filter:blur(8px);z-index:10;border-bottom:1px solid #1f2942}
    .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px}
    .title{display:flex;gap:10px;align-items:center}
    .title h1{font-size:18px;margin:0;white-space:nowrap}
    .chip{font-size:12px;color:#0b1020;background:var(--accent);padding:4px 8px;border-radius:999px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    button,select,input,textarea{font:inherit;color:inherit}
    .btn{background:#1b2544;border:1px solid #26325a;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn:hover{background:#202c52}
    .btn.acc{background:var(--accent);border-color:#5fb0ff;color:#081123}
    .btn.ghost{background:transparent;border:1px dashed #32406c}
    .btn.small{padding:7px 9px;border-radius:10px;font-size:13px}
    .select,.input{background:#0e1430;border:1px solid #27345f;border-radius:12px;padding:10px 12px;color:var(--text)}
    .input{width:170px}.stage{margin-top:14px}
.card{position:relative;background:radial-gradient(120% 120% at 0% 0%,#151e3c,#0e1430);border:1px solid #25315a;border-radius:var(--radius);padding:18px 16px;box-shadow:0 10px 30px rgba(0,0,0,.45);min-height:300px;display:flex;flex-direction:column;justify-content:space-between}
.card-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
.meta{display:flex;gap:8px;align-items:center}
.pos{font-size:12px;color:#9fb3d7;background:#0a122d;border:1px solid #26325a;padding:4px 8px;border-radius:999px}
.chapter{font-size:12px;color:#081123;background:#90caf9;border:0;padding:4px 8px;border-radius:999px}
.hanzi{font-size:48px;line-height:1.1;margin:8px 0 0;letter-spacing:.5px}
.pinyin{font-size:18px;color:#cbd5e1;margin-top:6px}
.meaning{margin-top:6px;font-size:16px;color:#e5edff}
.example{margin-top:10px;border-top:1px dashed #2b3a6b;padding-top:10px;color:#d6e1ff}
.example small{display:block;color:#9fb3d7;margin-top:4px}

.quiz .mc{display:grid;grid-template-columns:1fr;gap:8px;margin:10px 0 6px}
.quiz .mc .btn{width:100%;text-align:left}
.stat{font-size:12px;color:#9fb3d7}
.right{color:var(--ok)}
.wrong{color:var(--danger)}

@media(max-width:760px){ .input{width:135px} .hanzi{font-size:40px} }

  </style>
</head>
<body>
  <header>
    <div class="bar wrap">
      <div class="title">
        <span class="chip">H5</span>
        <h1>ì¤‘êµ­ì–´ ë‹¨ì–´ì¥</h1>
      </div>
      <div class="controls">
        <input id="search" class="input" placeholder="ê²€ìƒ‰ (í•œì/ë³‘ìŒ/ëœ»/ì˜ˆë¬¸)" />
        <select id="filterPos" class="select">
          <option value="">í’ˆì‚¬ ì „ì²´</option>
          <option>ëª…ì‚¬</option><option>ë™ì‚¬</option><option>í˜•ìš©ì‚¬</option><option>ë¶€ì‚¬</option>
          <option>ëŒ€ëª…ì‚¬</option><option>ì „ì¹˜ì‚¬</option><option>ì ‘ì†ì‚¬</option><option>ìˆ˜ì‚¬</option><option>ì¡°ì‚¬</option><option>ê¸°íƒ€</option>
        </select>
        <select id="filterChap" class="select">
          <option value="">ëª¨ë“  ì±•í„°</option>
        </select>
        <button class="btn small" id="shuffleBtn">ì„ê¸°</button>
        <button class="btn small" id="prevBtn">ì´ì „</button>
        <button class="btn small" id="nextBtn">ë‹¤ìŒ</button>
        <button class="btn acc small" id="addBtn">ì¶”ê°€</button>
        <button class="btn ghost small" id="importBtn">ê°€ì ¸ì˜¤ê¸°</button>
        <button class="btn ghost small" id="exportBtn">ë‚´ë³´ë‚´ê¸°</button>
        <button class="btn small" id="loadSheet">ì‹œíŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn small" id="saveSheet">ì‹œíŠ¸ë¡œ ì €ì¥</button>
        <button class="btn small" id="quizBtn">í€´ì¦ˆ</button>
      </div>
    </div>
  </header>  <main class="wrap stage">
    <section class="card" id="card">
      <div class="card-header">
        <div class="meta">
          <span class="pos" id="pos">â€”</span>
          <span class="chapter" id="chap">â€”</span>
        </div>
      </div>
      <div>
        <div class="hanzi" id="hanzi">ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”</div>
        <div class="pinyin" id="pinyin"></div>
        <div class="meaning" id="meaning"></div>
        <div class="example" id="example"></div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="speakWord">ğŸ”Š ë‹¨ì–´ ë°œìŒ</button>
          <button class="btn" id="speakExample">ğŸ§ ì˜ˆë¬¸ ë°œìŒ</button>
        </div>
      </div>
    </section><div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"><span style="opacity:.7">Tip: Space=ë‹¤ìŒ, â†/â†’=ì´ì „/ë‹¤ìŒ, F=ì„ê¸°</span></div>

  </main>  <!-- ë‹¨ì–´ ì¶”ê°€ ëª¨ë‹¬ -->  <dialog id="addModal">
    <form method="dialog" style="padding:16px;background:#0b142f;color:var(--text);border:none;border-radius:18px;max-width:800px;width:92vw">
      <h3 style="margin:0 0 8px">ë‹¨ì–´ ì¶”ê°€</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <label>í•œì<input id="f_hanzi" class="input" placeholder="ä¾‹å¦‚ï¼šå­¦ä¹ " required></label>
        <label>ë³‘ìŒ<input id="f_pinyin" class="input" placeholder="xuÃ©xÃ­"></label>
        <label>ëœ»(í•œêµ­ì–´)<input id="f_meaning" class="input" placeholder="ê³µë¶€í•˜ë‹¤"></label>
        <label>í’ˆì‚¬<select id="f_pos" class="select"><option>ëª…ì‚¬</option><option selected>ë™ì‚¬</option><option>í˜•ìš©ì‚¬</option><option>ë¶€ì‚¬</option><option>ê¸°íƒ€</option></select></label>
        <label>ì±•í„°<input id="f_chap" class="input" placeholder="chapter1"></label>
        <div></div>
        <label style="grid-column:1/3">ì˜ˆë¬¸(ì¤‘êµ­ì–´)<textarea id="f_ex" class="input" style="min-height:80px"></textarea></label>
        <label style="grid-column:1/3">ì˜ˆë¬¸ ëœ»(í•œêµ­ì–´)<textarea id="f_exko" class="input" style="min-height:80px"></textarea></label>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button class="btn" value="cancel">ë‹«ê¸°</button>
        <button class="btn acc" id="saveAdd">ì €ì¥</button>
      </div>
    </form>
  </dialog>  <!-- í€´ì¦ˆ ëª¨ë‹¬ (4ì§€ì„ ë‹¤) -->  <dialog id="quizModal">
    <div class="quiz" style="padding:16px;background:#0b142f;color:var(--text);border:none;border-radius:18px;max-width:720px;width:92vw">
      <h3 style="margin:0 0 8px">í€´ì¦ˆ ëª¨ë“œ (4ì§€ì„ ë‹¤)</h3>
      <p id="quizQ" style="margin-top:8px"></p>
      <div id="mcOptions" class="mc"></div>
      <div class="stat" id="quizStat">ì •ë‹µ 0 / ì‹œë„ 0 (ì •í™•ë„ 0%)</div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="quizNext">ë‹¤ìŒ ë¬¸ì œ</button>
        <button class="btn" id="quizClose">ë‹«ê¸°</button>
      </div>
      <p id="quizMsg" class="stat"></p>
    </div>
  </dialog>  <!-- í€´ì¦ˆ ëª¨ë“œ ì„ íƒ ëª¨ë‹¬ -->  <dialog id="quizModeModal">
    <div style="padding:16px;background:#0b142f;color:var(--text);border:none;border-radius:18px;max-width:520px;width:92vw">
      <h3 style="margin:0 0 8px">í€´ì¦ˆ ëª¨ë“œ ì„ íƒ</h3>
      <p style="opacity:.8;margin:6px 0 10px">ì›í•˜ëŠ” ë¬¸ì œ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”.</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn acc" id="modeH2M">í•œì â†’ ëœ» (4ì§€ì„ ë‹¤)</button>
        <button class="btn" id="modeM2H">ëœ» â†’ í•œì (4ì§€ì„ ë‹¤)</button>
      </div>
      <div style="margin-top:12px;text-align:right">
        <button class="btn" id="quizModeClose">ë‹«ê¸°</button>
      </div>
    </div>
  </dialog>  <input type="file" id="filePicker" accept=".json,.csv" style="display:none" />  <script>
    // ===== 1) êµ¬ê¸€ ì‹œíŠ¸ ì›¹ì•± ì—”ë“œí¬ì¸íŠ¸ (ê³ ì • ì„¤ì •) =====
    // ì•„ë˜ ê°’ì„ ë³¸ì¸ Apps Script ë°°í¬ URLë¡œ ë°”ê¿”ì£¼ì„¸ìš”.
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwpY0YKjzzr2KIfWIi8bcdNR4eJqyk8Hr2cRY4tt2MuIv8syI_wStRpnry0JVCwHp8f/exec"; // â† ì—¬ê¸°ë¥¼ ì‹¤ì œ URLë¡œ êµì²´

    // ===== 2) ë°ì´í„°/ìƒíƒœ =====
    const LS_KEY = 'cn_vocab_cards_v4';
    let cards = load() || sample();
    let filteredIdxs = [...cards.keys()];
    let cursor = 0;

    const els = {
      hanzi: document.getElementById('hanzi'),
      pinyin: document.getElementById('pinyin'),
      meaning: document.getElementById('meaning'),
      example: document.getElementById('example'),
      pos: document.getElementById('pos'),
      chap: document.getElementById('chap'),
      filterPos: document.getElementById('filterPos'),
      filterChap: document.getElementById('filterChap'),
      search: document.getElementById('search'),
      addModal: document.getElementById('addModal'),
      quizModal: document.getElementById('quizModal'),
      quizQ: document.getElementById('quizQ'),
      mcOptions: document.getElementById('mcOptions'),
      quizStat: document.getElementById('quizStat'),
      quizMsg: document.getElementById('quizMsg'),
      quizModeModal: document.getElementById('quizModeModal')
    };

    const quizState = { mode:'hanzi2meaning', tried:0, correct:0, answer:'' };

    function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(e){ return []; } }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(cards)); }
    function sample(){ return [
      {hanzi:'å­¦ä¹ ', pinyin:'xuÃ©xÃ­', meaning:'ê³µë¶€í•˜ë‹¤', pos:'ë™ì‚¬', example:'æˆ‘å–œæ¬¢å­¦ä¹ ä¸­æ–‡ã€‚', example_ko:'ë‚˜ëŠ” ì¤‘êµ­ì–´ ê³µë¶€ë¥¼ ì¢‹ì•„í•´ìš”.', chapter:'chapter1'},
      {hanzi:'æœ‹å‹', pinyin:'pÃ©ngyou', meaning:'ì¹œêµ¬', pos:'ëª…ì‚¬', example:'ä»–æ˜¯æˆ‘çš„å¥½æœ‹å‹ã€‚', example_ko:'ê·¸ëŠ” ë‚˜ì˜ ì¢‹ì€ ì¹œêµ¬ì˜ˆìš”.', chapter:'chapter1'},
      {hanzi:'æ¼‚äº®', pinyin:'piÃ oliang', meaning:'ì˜ˆì˜ë‹¤', pos:'í˜•ìš©ì‚¬', example:'è¿™ä¸ªåŸå¸‚å¾ˆæ¼‚äº®ã€‚', example_ko:'ì´ ë„ì‹œëŠ” ë§¤ìš° ì˜ˆë»ìš”.', chapter:'chapter2'},
      {hanzi:'è€å¸ˆ', pinyin:'lÇoshÄ«', meaning:'ì„ ìƒë‹˜', pos:'ëª…ì‚¬', example:'æˆ‘çš„è€å¸ˆå¾ˆäº²åˆ‡ã€‚', example_ko:'ë‚˜ì˜ ì„ ìƒë‹˜ì€ ì¹œì ˆí•´ìš”.', chapter:'chapter2'},
      {hanzi:'åƒé¥­', pinyin:'chÄ«fÃ n', meaning:'ë°¥ì„ ë¨¹ë‹¤', pos:'ë™ì‚¬', example:'æˆ‘ä»¬ä¸€èµ·å»åƒé¥­å§ã€‚', example_ko:'ìš°ë¦¬ ê°™ì´ ë°¥ ë¨¹ìœ¼ëŸ¬ ê°€ì.', chapter:'chapter3'}
    ]; }

    function uniq(arr){ return [...new Set(arr.filter(Boolean))]; }

    // ===== 3) ë Œë”ë§ =====
    function current(){ return filteredIdxs.length ? cards[ filteredIdxs[cursor] ] : null; }
    function render(){
      buildChapterOptions();
      const c = current();
      if(!c){ els.hanzi.textContent='ê²°ê³¼ ì—†ìŒ'; els.pinyin.textContent=''; els.meaning.textContent=''; els.example.textContent=''; els.pos.textContent='â€”'; els.chap.textContent='â€”'; return; }
      els.hanzi.textContent = c.hanzi||'';
      els.pinyin.textContent = c.pinyin||'';
      els.meaning.textContent = c.meaning||'';
      els.pos.textContent = c.pos||'â€”';
      els.chap.textContent = (c.chapter||'â€”').toUpperCase();
      const exH = c.example? 'ğŸ“Œ '+escapeHTML(c.example) : '';
      const exK = c.example_ko? '<small>'+escapeHTML(c.example_ko)+'</small>' : '';
      els.example.innerHTML = exH + (exH&&exK?'<br>':'') + exK;
    }
    function escapeHTML(s=''){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])); }

    // ===== 4) í•„í„°/ê²€ìƒ‰ =====
    function buildChapterOptions(){
      const cur = els.filterChap.value;
      const opts = [''].concat(uniq(cards.map(c=>c.chapter)));
      els.filterChap.innerHTML = opts.map(v=>`<option value="${v}">${v? v : 'ëª¨ë“  ì±•í„°'}</option>`).join('');
      if(opts.includes(cur)) els.filterChap.value = cur;
    }
    function applyFilter(){
      const q = (els.search.value||'').trim().toLowerCase();
      const fpos = els.filterPos.value;
      const fch = els.filterChap.value;
      filteredIdxs = cards.map((c,i)=>({c,i}))
        .filter(({c})=> fpos? c.pos===fpos : true)
        .filter(({c})=> fch? (c.chapter||'')===fch : true)
        .filter(({c})=>{ const blob=[c.hanzi,c.pinyin,c.meaning,c.example,c.example_ko,c.chapter].join('\n').toLowerCase(); return q? blob.includes(q) : true; })
        .map(x=>x.i);
      if(!filteredIdxs.length){ cursor=0; render(); return; }
      cursor=0; render();
    }

    // ===== 5) ë‚´ë¹„ê²Œì´ì…˜ =====
    function next(){ if(!filteredIdxs.length) return; cursor=(cursor+1)%filteredIdxs.length; render(); }
    function prev(){ if(!filteredIdxs.length) return; cursor=(cursor-1+filteredIdxs.length)%filteredIdxs.length; render(); }
    function shuffle(){ for(let i=filteredIdxs.length-1;i>0;i--){ const j=(Math.random()*(i+1)|0); [filteredIdxs[i],filteredIdxs[j]]=[filteredIdxs[j],filteredIdxs[i]]; } cursor=0; render(); }

    // ===== 6) ì¶”ê°€ ëª¨ë‹¬ =====
    document.getElementById('addBtn').onclick=()=>{ els.addModal.showModal(); document.getElementById('f_hanzi').focus(); };
    document.getElementById('saveAdd').onclick=(e)=>{
      e.preventDefault();
      const item={ hanzi:val('f_hanzi'), pinyin:val('f_pinyin'), meaning:val('f_meaning'), pos:val('f_pos'), example:val('f_ex'), example_ko:val('f_exko'), chapter:val('f_chap') };
      if(!item.hanzi){ alert('í•œìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”'); return; }
      cards.push(item); save(); applyFilter(); els.addModal.close(); cursor=filteredIdxs.length-1; render();
    };
    function val(id){ return (document.getElementById(id).value||'').trim(); }

    // ===== 7) íŒŒì¼ ì…/ì¶œë ¥ =====
    document.getElementById('exportBtn').onclick=()=>{ const blob=new Blob([JSON.stringify(cards,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cn-vocab.json'; a.click(); };
    const picker=document.getElementById('filePicker');
    document.getElementById('importBtn').onclick=()=>picker.click();
    picker.onchange=async (e)=>{ const file=e.target.files[0]; if(!file) return; const text=await file.text();
      if(file.name.endsWith('.json')){ try{ const arr=JSON.parse(text); cards = Array.isArray(arr)? arr : (arr && Array.isArray(arr.data)? arr.data : cards); save(); applyFilter(); render(); }catch(err){ alert('JSON íŒŒì‹± ì˜¤ë¥˜'); } }
      else if(file.name.endsWith('.csv')){ const rows=text.split(/\n+/).map(r=>r.trim()).filter(Boolean); cards=rows.map(r=>{ const [hanzi,pinyin,meaning,pos,example,example_ko,chapter]=r.split(','); return {hanzi,pinyin,meaning,pos,example,example_ko,chapter}; }); save(); applyFilter(); render(); }
      e.target.value=''; };

    // ===== 8) êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ (ê³ ì • ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©) =====
    async function loadFromSheet(){ if(!GAS_ENDPOINT){ alert('GAS_ENDPOINTê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
      try{ const res=await fetch(GAS_ENDPOINT+"?action=read",{method:'GET'}); const js=await res.json(); const data=Array.isArray(js)? js : (js && js.data ? js.data : []);
        if(Array.isArray(data)){ cards=data; save(); applyFilter(); render(); alert('ì‹œíŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: '+cards.length+'ê°œ'); }
        else alert('í˜•ì‹ ì˜¤ë¥˜: data ë°°ì—´ì´ ì—†ìŠµë‹ˆë‹¤');
      }catch(err){ alert('ì‹œíŠ¸ í†µì‹  ì˜¤ë¥˜: '+err); }
    }
    async function saveToSheet(){ if(!GAS_ENDPOINT){ alert('GAS_ENDPOINTê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
      try{ const res=await fetch(GAS_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'write',data:cards})}); const js=await res.json(); const ok=js && (js.ok || js.rows>=0); alert(ok? 'ì‹œíŠ¸ ì €ì¥ ì™„ë£Œ' : 'ì €ì¥ ì‹¤íŒ¨'); }
      catch(err){ alert('ì‹œíŠ¸ í†µì‹  ì˜¤ë¥˜: '+err); }
    }
    document.getElementById('loadSheet').onclick=loadFromSheet;
    document.getElementById('saveSheet').onclick=saveToSheet;

    // ===== 9) í€´ì¦ˆ (4ì§€ì„ ë‹¤) =====
    document.getElementById('quizBtn').onclick=()=>{ if(!filteredIdxs.length){ alert('ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ í•„í„°ë¥¼ ë¹„ì›Œë³´ì„¸ìš”.'); return; } els.quizModeModal.showModal(); };
    document.getElementById('quizClose').onclick=()=>els.quizModal.close();
    document.getElementById('quizNext').onclick=()=>{ next(); nextQuestion(); };
    document.getElementById('modeH2M').onclick=()=>{ quizState.mode='hanzi2meaning'; startQuiz(); };
    document.getElementById('modeM2H').onclick=()=>{ quizState.mode='meaning2hanzi'; startQuiz(); };
    document.getElementById('quizModeClose').onclick=()=>els.quizModeModal.close();

    function startQuiz(){ quizState.tried=0; quizState.correct=0; els.quizMsg.textContent=''; updateQuizStat(); nextQuestion(); els.quizModeModal.close(); els.quizModal.showModal(); }
    function updateQuizStat(){ const acc=quizState.tried? Math.round(quizState.correct/quizState.tried*100):0; els.quizStat.textContent=`ì •ë‹µ ${quizState.correct} / ì‹œë„ ${quizState.tried} (ì •í™•ë„ ${acc}%)`; }
    function normalizeKo(s=''){ return s.replace(/\s+/g,'').replace(/[.,!?:;~Â·]/g,''); }
    function normalizeZh(s=''){ return s.replace(/\s+/g,'').replace(/[ï¼Œã€‚ï¼ï¼Ÿï¼šï¼›ã€Â·~]/g,''); }

    function nextQuestion(){ const c=current(); if(!c){ els.quizQ.textContent='ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤'; return; }
      const askHanzi=(quizState.mode==='hanzi2meaning'); els.quizQ.textContent= askHanzi? `ì´ ë‹¨ì–´ì˜ ëœ»ì€ ë¬´ì—‡ì¼ê¹Œìš”? â†’ ${c.hanzi}` : `ì´ ëœ»ì— í•´ë‹¹í•˜ëŠ” í•œìëŠ” ë¬´ì—‡ì¼ê¹Œìš”? â†’ ${c.meaning}`;
      const answer = askHanzi ? (c.meaning||'') : (c.hanzi||''); quizState.answer=answer;
      const field = askHanzi ? 'meaning' : 'hanzi'; const pool=filteredIdxs.map(i=>cards[i][field]).filter(Boolean);
      for(let i=pool.length-1;i>0;i--){ const j=(Math.random()*(i+1)|0); [pool[i],pool[j]]=[pool[j],pool[i]]; }
      const optsSet=new Set([answer]);
      for(const v of pool){ if(optsSet.size>=4) break; if(compareChoice(v,answer)) continue; optsSet.add(v); }
      const opts=Array.from(optsSet); while(opts.length<4 && pool.length){ const v=pool[(Math.random()*pool.length)|0]; if(!compareChoice(v,answer) && !opts.includes(v)) opts.push(v); }
      for(let i=opts.length-1;i>0;i--){ const j=(Math.random()*(i+1)|0); [opts[i],opts[j]]=[opts[j],opts[i]]; }
      els.mcOptions.innerHTML='';
      opts.forEach(opt=>{ const b=document.createElement('button'); b.className='btn'; b.textContent=opt; b.onclick=()=>{ quizState.tried++; const ok=isCorrect(opt,answer,askHanzi); if(ok) quizState.correct++; els.quizMsg.textContent= ok? 'âœ… ì •ë‹µ!' : ('âŒ ì˜¤ë‹µ. ì •ë‹µ: '+answer); updateQuizStat(); }; els.mcOptions.appendChild(b); });
      els.quizMsg.textContent='';
    }
    function compareChoice(a,b){ if(a==null||b==null) return false; const A=/[\u4e00-\u9fa5]/.test(a)? normalizeZh(a):normalizeKo(a); const B=/[\u4e00-\u9fa5]/.test(b)? normalizeZh(b):normalizeKo(b); return A===B; }
    function isCorrect(pick,answer,askHanzi){ return askHanzi? (normalizeKo(pick)===normalizeKo(answer)) : (normalizeZh(pick)===normalizeZh(answer)); }

    // ===== 10) TTS (ì¤‘êµ­ì–´ ìš°ì„ ) =====
    let voices=[]; function loadVoices(){ try{ voices = window.speechSynthesis? speechSynthesis.getVoices():[]; }catch(e){ voices=[]; } }
    if('speechSynthesis' in window){ loadVoices(); speechSynthesis.onvoiceschanged=loadVoices; }
    function pickZh(){ return voices.find(v=>/zh|Chinese|Mandarin/i.test(((v.lang||'')+v.name))) || null; }
    function speak(text){ if(!text || !('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(text); const v=pickZh(); u.lang=(v&&v.lang)||'zh-CN'; if(v) u.voice=v; u.rate=1.0; u.pitch=1.0; try{ speechSynthesis.cancel(); setTimeout(()=>speechSynthesis.speak(u),0); }catch(e){} }
    document.getElementById('speakWord').onclick=()=>{ const c=current(); if(c){ speak(c.hanzi); } };
    document.getElementById('speakExample').onclick=()=>{ const c=current(); if(c){ speak(c.example||c.hanzi); } };

    // ===== 11) ì´ë²¤íŠ¸ =====
    document.getElementById('nextBtn').onclick=next; document.getElementById('prevBtn').onclick=prev; document.getElementById('shuffleBtn').onclick=shuffle;
    els.search.oninput=applyFilter; els.filterPos.onchange=applyFilter; els.filterChap.onchange=applyFilter;
    document.addEventListener('keydown',(e)=>{ if(['INPUT','TEXTAREA','DIALOG'].includes(e.target.tagName)) return; if(e.code==='Space'){ e.preventDefault(); next(); } if(e.key==='ArrowRight') next(); if(e.key==='ArrowLeft') prev(); if(e.key.toLowerCase()==='f') shuffle(); });

    // ===== 12) ì´ˆê¸°í™” =====
    applyFilter(); render();
  </script>  <!--
  â–¶ êµ¬ê¸€ Apps Script (ì‹œíŠ¸ ì²« ë²ˆì§¸ ì‹œíŠ¸ ê¸°ì¤€)
  function doGet(e){
    const sheet = SpreadsheetApp.getActive().getSheets()[0];
    const rows = sheet.getDataRange().getValues();
    rows.shift();
    const items = rows.filter(r=>r[0]).map(r=>({
      hanzi:r[0], pinyin:r[1], meaning:r[2], pos:r[3], example:r[4], example_ko:r[5], chapter:r[6]||''
    }));
    return ContentService.createTextOutput(JSON.stringify({ok:true,data:items})).setMimeType(ContentService.MimeType.JSON);
  }
  function doPost(e){
    const sheet = SpreadsheetApp.getActive().getSheets()[0];
    const body = JSON.parse(e.postData.contents||'{}');
    if(body.action==='write' && Array.isArray(body.data)){
      sheet.clear();
      const head=['hanzi','pinyin','meaning','pos','example','example_ko','chapter'];
      sheet.appendRow(head);
      body.data.forEach(it=>sheet.appendRow([it.hanzi||'',it.pinyin||'',it.meaning||'',it.pos||'',it.example||'',it.example_ko||'',it.chapter||'' ]));
      return ContentService.createTextOutput(JSON.stringify({ok:true,rows:body.data.length})).setMimeType(ContentService.MimeType.JSON);
    }
    return ContentService.createTextOutput(JSON.stringify({ok:false})).setMimeType(ContentService.MimeType.JSON);
  }
  --></body>
</html>
