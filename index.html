<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>중국어 단어장 · 모바일</title>
  <style>
    :root{
      --bg:#0b1020; --bg2:#0f1630; --panel:#0e1430; --accent:#4da3ff; --text:#e6eefc; --muted:#9fb3d7;
      --ok:#22c55e; --danger:#ef4444; --shadow:0 10px 30px rgba(0,0,0,.45); --r:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font-family:Pretendard,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow-y:auto}
    .wrap{max-width:860px;margin:0 auto;padding:16px 16px 96px}
    header h1{margin:0;font-size:22px}
    header input,header select,label.filter{padding:10px;border-radius:10px;border:1px solid #2e3b5c;background:#141b33;color:var(--text)}
    label.filter{display:inline-flex;align-items:center;gap:6px;border:none}
    label.filter input{width:18px;height:18px}

    .btn{background:#1e2a4a;border:1px solid #2e3b5c;color:var(--text);padding:10px 14px;border-radius:14px;cursor:pointer;transition:.15s;box-shadow:var(--shadow)}
    .btn:active{transform:translateY(1px)}
    .btn:hover{background:#28385f}
    .btn.acc{background:var(--accent);color:#081123;font-weight:600}
    .btn.ok{background:#1f5133;border-color:#2f7a4e}

    .card{background:radial-gradient(120% 120% at 0% 0%,#1a213d,var(--panel));padding:24px;border-radius:var(--r);min-height:260px;margin-top:58px;box-shadow:var(--shadow);text-align:center;position:relative}
    .hanzi{font-size:56px;margin-top:10px}
    .pinyin{font-size:20px;color:#cbd5e1;margin-top:6px}
    .meaning{margin-top:12px;font-size:18px;display:none}
    .example{margin-top:12px;font-size:16px;display:none;color:#d6e1ff}
    .today{font-size:12px;color:var(--muted);margin-left:8px}

    /* 카드 위 고정 네비게이션 */
    .navBtns{position:absolute;top:-46px;left:0;right:0;display:flex;justify-content:space-between}

    /* === QUIZ OVERLAY === */
    .quizOverlay{position:fixed;inset:0;width:100vw;height:100dvh;background:rgba(8,12,28,.98);display:none;flex-direction:column;z-index:9999}
    .quizOverlay.show{display:flex}
    body.lock{overflow:hidden;touch-action:none}

    .quizTop{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #1f2b52;gap:10px}
    .badge{font-size:12px;color:#081123;background:#90caf9;border-radius:999px;padding:6px 10px}
    .timer{font-weight:700;font-size:18px;color:var(--text)}
    .modeToggle{display:flex;gap:6px;align-items:center;justify-content:center}
    .seg{border:1px solid #2e3b5c;background:#172049;color:#e6eefc;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}
    .seg[aria-pressed="true"]{background:#4da3ff;color:#081123;border-color:#5fb0ff;font-weight:700}

    .quizBody{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:16px;overflow:hidden}
    .qText{color:var(--text);font-size:clamp(28px,9vw,64px);text-align:center;line-height:1.2;margin:0 0 16px;word-break:keep-all}
    .opts{width:min(920px,92vw);display:grid;grid-template-columns:1fr;gap:10px}
    .opt{font-size:clamp(18px,5.2vw,26px);padding:16px 14px;border-radius:14px;border:2px solid #2e3b5c;background:#1b2446;color:var(--text);text-align:center;transition:border-color .15s, box-shadow .15s}
    .opt:active{transform:translateY(1px)}
    .opt.correct{border-color:var(--ok);box-shadow:0 0 0 2px rgba(34,197,94,.3) inset}
    .opt.wrong{border-color:var(--danger);box-shadow:0 0 0 2px rgba(239,68,68,.3) inset}

    .quizBottom{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px solid #1f2b52;padding-bottom:calc(12px + env(safe-area-inset-bottom,0px))}
    .stat{font-size:13px;color:var(--muted)}
    @media(min-width:700px){ .opts{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <header class="wrap">
    <h1>중국어 단어장 <span id="todayStat" class="today"></span></h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center">
      <input id="search" placeholder="검색 (한자/뜻)" />
      <select id="filterPos"><option value="">품사 전체</option><option>명사</option><option>동사</option><option>형용사</option></select>
      <select id="filterChap"><option value="">모든 챕터</option></select>
      <label class="filter"><input type="checkbox" id="hideLearned" checked> 외운 단어 제외</label>
      <button class="btn acc" id="quizBtn">퀴즈</button>
      <button class="btn" id="syncBtn">시트 동기화</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card" id="card">
      <div class="navBtns">
        <button class="btn" id="prevBtn">⬅️ 이전</button>
        <button class="btn" id="nextBtn">다음 ➡️</button>
      </div>
      <div class="hanzi" id="hanzi">단어를 불러오세요</div>
      <div class="pinyin" id="pinyin"></div>
      <div class="meaning" id="meaning"></div>
      <div class="example" id="example"></div>
      <div style="margin-top:16px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
        <button class="btn" id="speakWord">🔊 단어 발음</button>
        <button class="btn" id="speakExample">🎧 예문 발음(느리게)</button>
        <button class="btn ok" id="toggleLearned">✅ 외웠다</button>
        <button class="btn" id="revealBtn">뜻 보기</button>
      </div>
    </section>
  </main>

  <!-- 퀴즈 오버레이 -->
  <div id="quizOverlay" class="quizOverlay" aria-hidden="true">
    <div class="quizTop">
      <span class="badge" id="goalBadge">목표 20</span>
      <div class="modeToggle">
        <button class="seg" id="modeH2MTop" aria-pressed="true">한자→뜻</button>
        <button class="seg" id="modeM2HTop" aria-pressed="false">뜻→한자</button>
      </div>
      <span class="timer" id="quizTimer">5</span>
    </div>
    <div class="quizBody">
      <h2 class="qText" id="qText">—</h2>
      <div class="opts" id="mcOptions"></div>
    </div>
    <div class="quizBottom">
      <span class="stat" id="quizStat">정답 0 / 시도 0 (0%)</span>
      <div style="display:flex;gap:8px">
        <button class="btn" id="quizExit">끝내기</button>
        <button class="btn acc" id="quizSkip">건너뛰기</button>
      </div>
    </div>
  </div>

  <script>
    // ===== 설정 =====
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbwpY0YKjzzr2KIfWIi8bcdNR4eJqyk8Hr2cRY4tt2MuIv8syI_wStRpnry0JVCwHp8f/exec";
    const LS_CARDS = 'cn_vocab_cards_v11';
    const LS_SCORE = 'cn_vocab_score_v1';
    const LS_LEARNED = 'cn_vocab_learned_v1';
    const DAILY_GOAL = 20;

    // ===== 상태 =====
    let cards = JSON.parse(localStorage.getItem(LS_CARDS)||'[]');
    let learned = JSON.parse(localStorage.getItem(LS_LEARNED)||'{}');
    let filteredIdxs = cards.map((_,i)=>i);
    let cursor=0; let quizMode=null; let quizAnswer=''; let timerId=null;
    let quizOrder=[]; let quizIdx=0; let quizLock=false;

    // ===== 유틸 =====
    function todayKey(){ const d=new Date(); const m=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${m(d.getMonth()+1)}-${m(d.getDate())}`; }
    function getScore(){ const all=JSON.parse(localStorage.getItem(LS_SCORE)||'{}'); const k=todayKey(); if(!all[k]) all[k]={attempts:0,correct:0,goal:DAILY_GOAL}; localStorage.setItem(LS_SCORE,JSON.stringify(all)); return all[k]; }
    function setScore(s){ const all=JSON.parse(localStorage.getItem(LS_SCORE)||'{}'); all[todayKey()]=s; localStorage.setItem(LS_SCORE,JSON.stringify(all)); }
    function saveCards(){ localStorage.setItem(LS_CARDS, JSON.stringify(cards)); }
    function saveLearned(){ localStorage.setItem(LS_LEARNED, JSON.stringify(learned)); }
    function uniq(arr){ return [...new Set(arr.filter(Boolean))]; }
    function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=(Math.random()*(i+1)|0); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

    // ===== 현재/뷰 =====
    function current(){ return filteredIdxs.length? cards[ filteredIdxs[cursor] ] : null; }
    function updateHeaderStat(){ const s=getScore(); const acc=s.attempts? Math.round(s.correct/s.attempts*100):0; document.getElementById('todayStat').textContent=`· 오늘 정답 ${s.correct}/${s.attempts} (정확도 ${acc}%) · 목표 ${s.goal}`; document.getElementById('goalBadge').textContent=`목표 ${s.goal}`; document.getElementById('quizStat').textContent=`정답 ${s.correct} / 시도 ${s.attempts} (${acc}%)`; }

    function buildChapterOptions(){ const sel=document.getElementById('filterChap'); const cur=sel.value; const chaps=uniq(cards.map(c=>c.chapter)); sel.innerHTML=['<option value="">모든 챕터</option>'].concat(chaps.map(c=>`<option value="${c}">${c}</option>`)).join(''); if(chaps.includes(cur)) sel.value=cur; }

    function render(){
      buildChapterOptions();
      const c=current();
      if(!c){ hanzi.textContent='결과 없음'; pinyin.textContent=''; meaning.textContent=''; example.textContent=''; updateHeaderStat(); return; }
      hanzi.textContent=c.hanzi||''; pinyin.textContent=c.pinyin||'';
      meaning.style.display='none'; example.style.display='none';
      meaning.textContent=c.meaning||'';
      example.textContent=c.example ? (c.example + (c.example_ko ? ` (${c.example_ko})` : '')) : '';
      document.getElementById('toggleLearned').textContent = learned[c.hanzi] ? '✅ 외움 해제' : '✅ 외웠다';
      updateHeaderStat();
    }

    function applyFilter(resetCursor=true){
      const q=(document.getElementById('search').value||'').trim().toLowerCase();
      const pos=document.getElementById('filterPos').value;
      const ch=document.getElementById('filterChap').value;
      const hideL=document.getElementById('hideLearned').checked;
      filteredIdxs = cards.map((c,i)=>({c,i}))
        .filter(({c})=> pos? (c.pos===pos) : true)
        .filter(({c})=> ch? ((c.chapter||'')===ch) : true)
        .filter(({c})=> hideL? !learned[c.hanzi] : true)
        .filter(({c})=>{ const blob=[c.hanzi,c.pinyin,c.meaning,c.example,c.example_ko,c.chapter].join("
").toLowerCase(); return q? blob.includes(q):true; })
        .map(x=>x.i);
      if(resetCursor) cursor=0;
    }

    // ===== 내비게이션 =====
    function next(){ if(!filteredIdxs.length) return; cursor=(cursor+1)%filteredIdxs.length; render(); }
    function prev(){ if(!filteredIdxs.length) return; cursor=(cursor-1+filteredIdxs.length)%filteredIdxs.length; render(); }

    // ===== 시트 동기화 =====
    async function sync(){
      try{
        const res=await fetch(SHEET_URL+"?action=read");
        const js=await res.json();
        const data=Array.isArray(js)? js : (js&&js.data?js.data:[]);
        if(Array.isArray(data)){
          cards=data; saveCards();
          applyFilter(); cursor=0; render();
          alert('동기화 완료: '+cards.length+'개');
        }
      }catch(e){ alert('동기화 실패: '+e); }
    }

    // ===== 퀴즈(오버레이) =====
    const overlay = document.getElementById('quizOverlay');
    function openOverlay(){ overlay.classList.add('show'); document.body.classList.add('lock'); }
    function closeOverlay(){ overlay.classList.remove('show'); document.body.classList.remove('lock'); clearTimer(); }

    function startQuiz(){
      if(!filteredIdxs.length){ alert('문항이 없습니다'); return; }
      if(!quizMode) quizMode='hanzi2meaning';
      quizOrder = shuffle(filteredIdxs.slice());
      quizIdx = 0;
      openOverlay();
      nextQuiz();
    }

    function nextQuiz(){
      clearTimer();
      if(!quizOrder.length){ quizOrder = shuffle(filteredIdxs.slice()); quizIdx = 0; }
      if(quizIdx >= quizOrder.length){ quizOrder = shuffle(filteredIdxs.slice()); quizIdx = 0; }
      const idx = quizOrder[quizIdx];
      const pos = filteredIdxs.indexOf(idx);
      cursor = (pos!==-1)? pos : 0;

      const c=current(); if(!c){ closeOverlay(); return; }
      const askH=(quizMode==='hanzi2meaning');
      const q = askH ? (c.hanzi||'') : (c.meaning||'');
      quizAnswer = askH ? (c.meaning||'') : (c.hanzi||'');
      document.getElementById('qText').textContent=q;

      const field = askH ? 'meaning' : 'hanzi';
      const pool = filteredIdxs.map(i=>cards[i][field]).filter(Boolean);
      for(let i=pool.length-1;i>0;i--){ const j=(Math.random()*(i+1)|0); [pool[i],pool[j]]=[pool[j],pool[i]]; }
      const opts=new Set([quizAnswer]);
      for(const v of pool){ if(opts.size>=4) break; if(v!==quizAnswer) opts.add(v); }
      const arr=[...opts]; for(let i=arr.length-1;i>0;i--){ const j=(Math.random()*(i+1)|0); [arr[i],arr[j]]=[arr[j],arr[i]]; }
      const cont=document.getElementById('mcOptions'); cont.innerHTML='';
      arr.forEach(t=>{ const b=document.createElement('button'); b.className='opt'; b.textContent=t; b.onclick=()=>gradeOption(b,t,cont); cont.appendChild(b); });

      quizLock=false;
      let remain=5; document.getElementById('quizTimer').textContent=remain;
      timerId=setInterval(()=>{ remain--; document.getElementById('quizTimer').textContent=remain; if(remain<=0){ grade(null,true); } },1000);

      document.getElementById('modeH2MTop').setAttribute('aria-pressed', askH ? 'true' : 'false');
      document.getElementById('modeM2HTop').setAttribute('aria-pressed', askH ? 'false' : 'true');
    }

    function grade(choice, timeout=false){
      clearTimer();
      const s=getScore(); s.attempts++;
      const ok = (!timeout && choice===quizAnswer);
      if(ok) s.correct++;
      setScore(s); updateHeaderStat();
      if(ok){ playDing(); const c=current(); if(c){ learned[c.hanzi]=true; saveLearned(); }}
      quizIdx++;
      setTimeout(()=>{ nextQuiz(); }, 500);
    }

    function gradeOption(btn, choice, cont){
      if(quizLock) return; quizLock=true;
      const ok = (choice===quizAnswer);
      if(ok){ btn.classList.add('correct'); }
      else{
        btn.classList.add('wrong');
        [...cont.children].forEach(el=>{ if(el.textContent===quizAnswer) el.classList.add('correct'); });
      }
      grade(choice,false);
    }

    function clearTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }

    // ===== TTS & 효과음 =====
    function speakZh(text, rate=1){
      if(!('speechSynthesis' in window) || !text) return;
      const u=new SpeechSynthesisUtterance(text);
      u.lang='zh-CN';
      u.rate=rate; // 속도 조절
      u.pitch=1;
      try{ speechSynthesis.cancel(); setTimeout(()=>speechSynthesis.speak(u),0); }catch(e){}
    }
    function playDing(){
      const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return;
      const ctx=new AC(); const now=ctx.currentTime;
      const o1=ctx.createOscillator(), g1=ctx.createGain();
      o1.type='sine'; o1.frequency.setValueAtTime(880,now);
      g1.gain.setValueAtTime(0.0001,now); g1.gain.exponentialRampToValueAtTime(0.25,now+0.01); g1.gain.exponentialRampToValueAtTime(0.0001,now+0.23);
      o1.connect(g1).connect(ctx.destination); o1.start(now); o1.stop(now+0.24);
      const o2=ctx.createOscillator(), g2=ctx.createGain();
      o2.type='sine'; o2.frequency.setValueAtTime(660,now+0.26);
      g2.gain.setValueAtTime(0.0001,now+0.26); g2.gain.exponentialRampToValueAtTime(0.22,now+0.27); g2.gain.exponentialRampToValueAtTime(0.0001,now+0.52);
      o2.connect(g2).connect(ctx.destination); o2.start(now+0.26); o2.stop(now+0.53);
    }

    // ===== 이벤트 =====
    document.getElementById('speakWord').onclick=()=>{ const c=current(); if(c) speakZh(c.hanzi, 1); };
    document.getElementById('speakExample').onclick=()=>{ const c=current(); if(c) speakZh(c.example || c.hanzi, 0.8); };
    document.getElementById('revealBtn').onclick=()=>{ meaning.style.display='block'; example.style.display='block'; };

    document.getElementById('nextBtn').onclick=next;
    document.getElementById('prevBtn').onclick=prev;
    document.getElementById('syncBtn').onclick=sync;
    document.getElementById('quizBtn').onclick=startQuiz;
    document.getElementById('quizExit').onclick=()=>closeOverlay();
    document.getElementById('quizSkip').onclick=()=>{ quizIdx++; nextQuiz(); };

    document.getElementById('filterPos').onchange=()=>{ applyFilter(); render(); };
    document.getElementById('filterChap').onchange=()=>{ applyFilter(); render(); };
    document.getElementById('search').oninput=()=>{ applyFilter(); render(); };

    document.getElementById('modeH2MTop').onclick=()=>{ quizMode='hanzi2meaning'; nextQuiz(); };
    document.getElementById('modeM2HTop').onclick=()=>{ quizMode='meaning2hanzi'; nextQuiz(); };

    // 외운 단어 토글 (수동)
    document.getElementById('toggleLearned').onclick=()=>{
      const c=current(); if(!c) return;
      if(learned[c.hanzi]) delete learned[c.hanzi]; else learned[c.hanzi]=true;
      saveLearned(); render();
    };

    // ===== 초기화 =====
    applyFilter();
    render();
  </script>
</body>
</html>
