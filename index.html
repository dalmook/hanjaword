<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>중국어 단어장 · 모바일</title>
  <meta name="description" content="한자·병음·뜻·품사·챕터·예문 + 4지선다 퀴즈 + 구글 시트 연동 + 음성 발음" />
  <style>
    :root{
      --bg:#0b1020; --bg2:#0a0f23; --panel:#0f1530; --panel2:#121a3a; --accent:#4da3ff; --text:#e6eefc; --muted:#9fb3d7; --ok:#22c55e; --danger:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2) 50%,var(--bg));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:16px 16px 120px}
    header{position:sticky;top:0;background:rgba(10,15,35,.75);backdrop-filter:blur(10px);border-bottom:1px solid #1f2b52;z-index:10}
    header h1{font-size:18px;margin:0 0 8px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    input,select{background:#0e1430;border:1px solid #2a3a6c;color:var(--text);padding:10px 12px;border-radius:12px;min-width:130px}
    .btn{background:#1b254a;border:1px solid #2b3a6f;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);transition:transform .08s ease}
    .btn:active{transform:translateY(1px)}
    .btn.acc{background:var(--accent);border-color:#5fb0ff;color:#081123}

    /* Card */
    .card{position:relative;margin-top:14px;background:radial-gradient(120% 120% at 0% 0%,#162047,var(--panel));border:1px solid #27345f;border-radius:var(--r);padding:20px;min-height:260px;box-shadow:var(--shadow)}
    .hanzi{font-size:48px;letter-spacing:.4px}
    .pinyin{font-size:18px;color:#cbd5e1;margin-top:6px}
    .meaning{margin-top:10px;font-size:18px;user-select:none;cursor:pointer}
    .meaning.masked{color:var(--muted);opacity:.95}
    .example{margin-top:12px;border-top:1px dashed #2a3a6c;padding-top:10px;color:#d6e1ff}
    .actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}

    /* Quiz */
    dialog{border:none;border-radius:16px;background:#0b142f;color:var(--text)}
    #mcOptions{display:grid;grid-template-columns:1fr;gap:8px}

    /* Bottom nav on mobile */
    .bottom-bar{position:fixed;left:0;right:0;bottom:0;background:rgba(10,15,35,.85);backdrop-filter:blur(10px);border-top:1px solid #1f2b52;display:flex;gap:8px;padding:10px;justify-content:center}
    .bottom-bar .btn{min-width:110px}

    @media(min-width:700px){ #mcOptions{grid-template-columns:1fr 1fr} }
    @media(max-width:420px){ .hanzi{font-size:42px} }
  </style>
</head>
<body>
  <header class="wrap">
    <h1>중국어 단어장</h1>
    <div class="toolbar">
      <input id="search" placeholder="검색 (한자/뜻/예문)" />
      <select id="filterPos"><option value="">품사 전체</option><option>명사</option><option>동사</option><option>형용사</option></select>
      <select id="filterChap"><option value="">모든 챕터</option></select>
      <button class="btn acc" id="addBtn">추가</button>
      <button class="btn" id="quizBtn">퀴즈</button>
      <button class="btn" id="syncBtn">구글 시트 동기화</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card" id="card">
      <div class="hanzi" id="hanzi">단어를 불러오세요</div>
      <div class="pinyin" id="pinyin"></div>
      <div class="meaning" id="meaning"></div>
      <div class="example" id="example"></div>
      <div class="actions">
        <button class="btn" id="speakWord">🔊 단어 발음</button>
        <button class="btn" id="speakExample">🎧 예문 발음</button>
      </div>
    </section>
  </main>

  <!-- 하단 고정 내비게이션 -->
  <div class="bottom-bar">
    <button class="btn" id="prevBtn">⟵ 이전</button>
    <button class="btn" id="nextBtn">다음 ⟶</button>
  </div>

  <!-- 퀴즈 모드 -->
  <dialog id="quizModeModal">
    <div style="padding:16px">
      <h3>퀴즈 모드 선택</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn acc" id="modeH2M">한자 → 뜻</button>
        <button class="btn" id="modeM2H">뜻 → 한자</button>
      </div>
      <div style="margin-top:12px"><button class="btn" onclick="quizModeModal.close()">닫기</button></div>
    </div>
  </dialog>

  <dialog id="quizModal">
    <div style="padding:16px;max-width:720px;width:92vw">
      <h3>퀴즈</h3>
      <p id="quizQ"></p>
      <div id="mcOptions"></div>
      <p id="quizFeedback" style="margin:6px 0 10px;color:#9fb3d7"></p>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="quizNext">다음</button>
        <button class="btn" onclick="quizModal.close()">닫기</button>
      </div>
    </div>
  </dialog>

  <script>
    // 1) 구글 시트 웹앱 URL (고정 설정)
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbwpY0YKjzzr2KIfWIi8bcdNR4eJqyk8Hr2cRY4tt2MuIv8syI_wStRpnry0JVCwHp8f/exec";

    // 2) 상태
    const LS_KEY = 'cn_vocab_cards_v5';
    let cards = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
    let cursor=0; let quizMode=null; let quizCorrect='';

    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(cards)); }
    function current(){ return cards[cursor]||null; }

    // 3) 렌더 (뜻은 기본 비공개 → 탭 시 공개)
    function render(){
      const c=current();
      if(!c){ hanzi.textContent='단어 없음'; pinyin.textContent=''; meaning.textContent=''; example.textContent=''; return; }
      hanzi.textContent=c.hanzi||''; pinyin.textContent=c.pinyin||'';
      meaning.dataset.value = c.meaning || '';
      meaning.classList.add('masked');
      meaning.textContent = meaning.dataset.value ? '탭하여 뜻 보기' : '';
      example.textContent=c.example ? (c.example + (c.example_ko ? " ("+c.example_ko+")" : "")) : '';
    }

    // 4) 검색/필터 (간단형; 필요 시 확장 가능)
    search.oninput = ()=>applyFilter();
    filterPos.onchange = ()=>applyFilter();
    filterChap.onchange = ()=>applyFilter();
    function applyFilter(){ /* 필요 시 확장: 지금은 전체 cards 사용 */ }

    // 5) 이동
    function next(){ if(!cards.length) return; cursor=(cursor+1)%cards.length; render(); }
    function prev(){ if(!cards.length) return; cursor=(cursor-1+cards.length)%cards.length; render(); }

    // 6) 시트 동기화
    async function sync(){
      try{
        const res = await fetch(SHEET_URL+"?action=read");
        const js = await res.json();
        const data = Array.isArray(js)? js : (js&&js.data?js.data:[]);
        if(Array.isArray(data)){ cards=data; save(); cursor=0; render(); alert("동기화 완료: "+cards.length+"개"); }
        else alert("시트 응답 형식 오류");
      }catch(e){ alert("동기화 실패: "+e); }
    }

    // 7) 퀴즈
    function startQuiz(){ quizModeModal.showModal(); }
    function nextQuiz(){
      const c=current(); if(!c) return;
      if(quizMode==='hanzi2meaning'){
        quizQ.textContent=`뜻은 무엇일까요? → ${c.hanzi}`;
        quizCorrect=c.meaning||'';
        makeOptions('meaning');
      }else{
        quizQ.textContent=`한자는 무엇일까요? → ${c.meaning}`;
        quizCorrect=c.hanzi||'';
        makeOptions('hanzi');
      }
    }
    function makeOptions(field){
      const pool = cards.map(x=>x[field]).filter(Boolean);
      for(let i=pool.length-1;i>0;i--){const j=(Math.random()*(i+1)|0);[pool[i],pool[j]]=[pool[j],pool[i]];}
      const opts=new Set([quizCorrect]);
      for(const v of pool){ if(opts.size>=4) break; if(v!==quizCorrect) opts.add(v);} 
      const arr=[...opts];
      for(let i=arr.length-1;i>0;i--){const j=(Math.random()*(i+1)|0);[arr[i],arr[j]]=[arr[j],arr[i]];}
      mcOptions.innerHTML='';
      arr.forEach(t=>{
        const b=document.createElement('button');b.className='btn';b.textContent=t;
        b.onclick=()=>{ const ok=(t===quizCorrect); quizFeedback.textContent=(ok?'✅ 정답':'❌ 정답: '+quizCorrect); if(ok) playDing(); };
        mcOptions.appendChild(b);
      });
    }

    // 8) 음성 합성(TTS)
    function speakZh(text){
      if(!('speechSynthesis' in window) || !text) return;
      const u=new SpeechSynthesisUtterance(text);
      u.lang='zh-CN'; u.rate=1; u.pitch=1;
      try{ speechSynthesis.cancel(); setTimeout(()=>speechSynthesis.speak(u),0); }catch(e){}
    }

    // 9) 정답 효과음 (Web Audio로 ‘띵동’)
    function playDing(){
      const AC = window.AudioContext||window.webkitAudioContext; if(!AC) return; const ctx=new AC();
      const now=ctx.currentTime;
      const o1=ctx.createOscillator(), g1=ctx.createGain(); o1.type='sine'; o1.frequency.setValueAtTime(880, now);
      g1.gain.setValueAtTime(0.0001, now); g1.gain.exponentialRampToValueAtTime(0.25, now+0.01); g1.gain.exponentialRampToValueAtTime(0.0001, now+0.23);
      o1.connect(g1).connect(ctx.destination); o1.start(now); o1.stop(now+0.24);
      const o2=ctx.createOscillator(), g2=ctx.createGain(); o2.type='sine'; o2.frequency.setValueAtTime(660, now+0.26);
      g2.gain.setValueAtTime(0.0001, now+0.26); g2.gain.exponentialRampToValueAtTime(0.22, now+0.27); g2.gain.exponentialRampToValueAtTime(0.0001, now+0.52);
      o2.connect(g2).connect(ctx.destination); o2.start(now+0.26); o2.stop(now+0.53);
    }

    // 10) 뜻 토글(탭하여 보기)
    document.getElementById('meaning').addEventListener('click',()=>{
      const el = document.getElementById('meaning');
      const val = el.dataset.value||''; if(!val) return;
      if(el.classList.contains('masked')){ el.classList.remove('masked'); el.textContent=val; }
      else { el.classList.add('masked'); el.textContent='탭하여 뜻 보기'; }
    });

    // 11) 버튼/이벤트
    document.getElementById('speakWord').onclick=()=>{const c=current(); if(c) speakZh(c.hanzi);};
    document.getElementById('speakExample').onclick=()=>{const c=current(); if(c) speakZh(c.example||c.hanzi);};
    document.getElementById('nextBtn').onclick=()=>{ next(); };
    document.getElementById('prevBtn').onclick=()=>{ prev(); };
    document.getElementById('syncBtn').onclick=sync;
    document.getElementById('quizBtn').onclick=startQuiz;
    document.getElementById('quizNext').onclick=()=>{ next(); nextQuiz(); };
    document.getElementById('modeH2M').onclick=()=>{quizMode='hanzi2meaning'; nextQuiz(); quizModeModal.close(); quizModal.showModal();};
    document.getElementById('modeM2H').onclick=()=>{quizMode='meaning2hanzi'; nextQuiz(); quizModeModal.close(); quizModal.showModal();};

    // 12) 초기 렌더
    render();
  </script>

  <!-- Apps Script 예시
  function doGet(e){
    const sheet=SpreadsheetApp.getActive().getSheets()[0];
    const rows=sheet.getDataRange().getValues(); rows.shift();
    const items=rows.map(r=>({hanzi:r[0],pinyin:r[1],meaning:r[2],pos:r[3],example:r[4],example_ko:r[5],chapter:r[6]}));
    return ContentService.createTextOutput(JSON.stringify(items)).setMimeType(ContentService.MimeType.JSON);
  }
  -->
</body>
</html>
