<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ì¤‘êµ­ì–´ ë‹¨ì–´ì¥ Â· ëª¨ë°”ì¼</title>
  <meta name="description" content="í•œìÂ·ë³‘ìŒÂ·ëœ»Â·í’ˆì‚¬Â·ì±•í„°Â·ì˜ˆë¬¸ + 4ì§€ì„ ë‹¤ í€´ì¦ˆ + êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ + ìŒì„±" />
  <style>
    :root{
      --bg:#0b1020; --bg2:#0f1630; --panel:#0e1430; --accent:#4da3ff; --text:#e6eefc; --muted:#9fb3d7;
      --ok:#22c55e; --danger:#ef4444; --shadow:0 10px 30px rgba(0,0,0,.45); --r:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font-family:Pretendard,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:860px;margin:0 auto;padding:16px 16px 96px}
    header h1{margin:0;font-size:22px}
    header input,header select{padding:10px;border-radius:10px;border:1px solid #2e3b5c;background:#141b33;color:var(--text)}
    .btn{background:#1e2a4a;border:1px solid #2e3b5c;color:var(--text);padding:10px 14px;border-radius:14px;cursor:pointer;transition:.15s;box-shadow:var(--shadow)}
    .btn:active{transform:translateY(1px)}
    .btn:hover{background:#28385f}
    .btn.acc{background:var(--accent);color:#081123;font-weight:600}

    .card{background:radial-gradient(120% 120% at 0% 0%,#1a213d,var(--panel));padding:28px;border-radius:var(--r);min-height:260px;margin-top:18px;box-shadow:var(--shadow);text-align:center}
    .hanzi{font-size:56px;margin-top:14px}
    .pinyin{font-size:20px;color:#cbd5e1;margin-top:8px}
    .meaning{margin-top:12px;font-size:18px;display:none}
    .example{margin-top:14px;font-size:16px;display:none;color:#d6e1ff}
    .today{font-size:12px;color:var(--muted);margin-left:8px}

    /* === QUIZ FULLSCREEN === */
    #quizModal{padding:0}
    .quizFS{width:100vw;height:100vh;display:flex;flex-direction:column;gap:0;background:rgba(8,12,28,.96)}
    .quizTop{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #1f2b52}
    .badge{font-size:12px;color:#081123;background:#90caf9;border-radius:999px;padding:6px 10px}
    .timer{font-weight:700;font-size:18px}
    .quizBody{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:18px}
    .qText{font-size: clamp(28px, 8vw, 56px); text-align:center; line-height:1.2; margin:0 0 18px}
    .opts{width:min(920px,92vw); display:grid; grid-template-columns:1fr; gap:10px}
    .opt{font-size: clamp(18px, 5vw, 24px); padding:16px 14px; border-radius:14px; border:1px solid #2e3b5c; background:#1b2446; color:var(--text); text-align:center}
    .opt:active{transform:translateY(1px)}
    .quizBottom{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px solid #1f2b52}
    .stat{font-size:13px;color:var(--muted)}
    .ok{color:var(--ok)} .bad{color:var(--danger)}
    @media(min-width:700px){ .opts{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <header class="wrap">
    <h1>ì¤‘êµ­ì–´ ë‹¨ì–´ì¥ <span id="todayStat" class="today"></span></h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
      <input id="search" placeholder="ê²€ìƒ‰ (í•œì/ëœ»)" />
      <select id="filterPos"><option value="">í’ˆì‚¬ ì „ì²´</option><option>ëª…ì‚¬</option><option>ë™ì‚¬</option><option>í˜•ìš©ì‚¬</option></select>
      <select id="filterChap"><option value="">ëª¨ë“  ì±•í„°</option></select>
      <button class="btn acc" id="addBtn">ì¶”ê°€</button>
      <button class="btn" id="quizBtn">í€´ì¦ˆ</button>
      <button class="btn" id="syncBtn">êµ¬ê¸€ ì‹œíŠ¸ ë™ê¸°í™”</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card" id="card">
      <div class="hanzi" id="hanzi">ë‹¨ì–´ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”</div>
      <div class="pinyin" id="pinyin"></div>
      <div class="meaning" id="meaning"></div>
      <div class="example" id="example"></div>
      <div style="margin-top:16px;display:flex;gap:12px;justify-content:center">
        <button class="btn" id="speakWord">ğŸ”Š ë‹¨ì–´ ë°œìŒ</button>
        <button class="btn" id="speakExample">ğŸ§ ì˜ˆë¬¸ ë°œìŒ</button>
        <button class="btn" id="revealBtn">ëœ» ë³´ê¸°</button>
      </div>
    </section>
    <div style="margin-top:14px;text-align:center">
      <button class="btn" id="prevBtn">â¬…ï¸ ì´ì „</button>
      <button class="btn" id="nextBtn">ë‹¤ìŒ â¡ï¸</button>
    </div>
  </main>

  <!-- í€´ì¦ˆ ëª¨ë“œ -->
  <dialog id="quizModeModal">
    <div style="padding:16px">
      <h3>í€´ì¦ˆ ëª¨ë“œ ì„ íƒ</h3>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:10px">
        <button class="btn acc" id="modeH2M">í•œì â†’ ëœ»</button>
        <button class="btn" id="modeM2H">ëœ» â†’ í•œì</button>
      </div>
      <div style="margin-top:16px;text-align:right"><button class="btn" onclick="quizModeModal.close()">ë‹«ê¸°</button></div>
    </div>
  </dialog>

  <!-- í€´ì¦ˆ: ì „ì²´í™”ë©´ -->
  <dialog id="quizModal">
    <div class="quizFS">
      <div class="quizTop">
        <span class="badge" id="goalBadge">ëª©í‘œ 20</span>
        <span class="timer" id="quizTimer">5</span>
      </div>
      <div class="quizBody">
        <h2 class="qText" id="qText">â€”</h2>
        <div class="opts" id="mcOptions"></div>
      </div>
      <div class="quizBottom">
        <span class="stat" id="quizStat">ì •ë‹µ 0 / ì‹œë„ 0 (0%)</span>
        <div style="display:flex;gap:8px">
          <button class="btn" id="quizExit">ëë‚´ê¸°</button>
          <button class="btn acc" id="quizSkip">ê±´ë„ˆë›°ê¸°</button>
        </div>
      </div>
    </div>
  </dialog>

  <script>
    // ===== ì‹œíŠ¸ URL(ê³ ì •) =====
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbwpY0YKjzzr2KIfWIi8bcdNR4eJqyk8Hr2cRY4tt2MuIv8syI_wStRpnry0JVCwHp8f/exec";

    // ===== ë°ì´í„°/ìƒíƒœ =====
    const LS_CARDS = 'cn_vocab_cards_v6';
    const LS_SCORE = 'cn_vocab_score_v1'; // { 'YYYY-MM-DD': {attempts, correct, goal} }
    const DAILY_GOAL = 20; // ê¸°ë³¸ ëª©í‘œ (ì›í•˜ë©´ ìˆ˜ì •)

    let cards = JSON.parse(localStorage.getItem(LS_CARDS)||'[]');
    let cursor=0; let quizMode=null; let quizAnswer=''; let timerId=null; let remain=5;

    function todayKey(){ const d=new Date(); const m=(n)=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${m(d.getMonth()+1)}-${m(d.getDate())}`; }
    function getScore(){ const all=JSON.parse(localStorage.getItem(LS_SCORE)||'{}'); const k=todayKey(); if(!all[k]) all[k]={attempts:0,correct:0,goal:DAILY_GOAL}; localStorage.setItem(LS_SCORE,JSON.stringify(all)); return all[k]; }
    function setScore(s){ const all=JSON.parse(localStorage.getItem(LS_SCORE)||'{}'); all[todayKey()]=s; localStorage.setItem(LS_SCORE,JSON.stringify(all)); }
    function updateHeaderStat(){ const s=getScore(); const acc=s.attempts? Math.round(s.correct/s.attempts*100):0; document.getElementById('todayStat').textContent = `Â· ì˜¤ëŠ˜ ì •ë‹µ ${s.correct}/${s.attempts} (ì •í™•ë„ ${acc}%) Â· ëª©í‘œ ${s.goal}`; document.getElementById('goalBadge').textContent = `ëª©í‘œ ${s.goal}`; document.getElementById('quizStat').textContent = `ì •ë‹µ ${s.correct} / ì‹œë„ ${s.attempts} (${acc}%)`; }

    function saveCards(){ localStorage.setItem(LS_CARDS, JSON.stringify(cards)); }
    function current(){ return cards[cursor]||null; }

    // ===== ë Œë” =====
    function render(){
      const c=current();
      if(!c){ hanzi.textContent='ë‹¨ì–´ ì—†ìŒ'; pinyin.textContent=''; meaning.textContent=''; example.textContent=''; return; }
      hanzi.textContent=c.hanzi||''; pinyin.textContent=c.pinyin||'';
      meaning.style.display='none'; example.style.display='none';
      meaning.textContent=c.meaning||'';
      example.textContent=c.example? c.example + (c.example_ko? ` (${c.example_ko})`:'') : '';
      updateHeaderStat();
    }

    // ===== ë‚´ë¹„ê²Œì´ì…˜ =====
    function next(){ if(!cards.length) return; cursor=(cursor+1)%cards.length; render(); }
    function prev(){ if(!cards.length) return; cursor=(cursor-1+cards.length)%cards.length; render(); }

    // ===== ì‹œíŠ¸ ë™ê¸°í™” =====
    async function sync(){
      try{
        const res=await fetch(SHEET_URL+"?action=read");
        const js=await res.json();
        const data=Array.isArray(js)? js : (js&&js.data?js.data:[]);
        if(Array.isArray(data)){ cards=data; saveCards(); cursor=0; render(); alert('ë™ê¸°í™” ì™„ë£Œ: '+cards.length+'ê°œ'); }
      }catch(e){ alert('ë™ê¸°í™” ì‹¤íŒ¨: '+e); }
    }

    // ===== í€´ì¦ˆ =====
    function startQuiz(){ if(!cards.length){alert('ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤'); return;} quizModeModal.showModal(); }
    document.getElementById('modeH2M').onclick=()=>{ quizMode='hanzi2meaning'; openQuiz(); };
    document.getElementById('modeM2H').onclick=()=>{ quizMode='meaning2hanzi'; openQuiz(); };

    function openQuiz(){ quizModeModal.close(); quizModal.showModal(); nextQuiz(); }

    function nextQuiz(){
      clearTimer(); // íƒ€ì´ë¨¸ ì´ˆê¸°í™”
      const c=current(); if(!c){ closeQuiz(); return; }
      // ë¬¸ì œ í…ìŠ¤íŠ¸: ì•ˆë‚´ ë¬¸êµ¬ ì—†ì´ "ë¬¸ì œ ê·¸ ìì²´"ë§Œ í¬ê²Œ í‘œê¸°
      const q = (quizMode==='hanzi2meaning') ? (c.hanzi||'') : (c.meaning||'');
      quizAnswer = (quizMode==='hanzi2meaning') ? (c.meaning||'') : (c.hanzi||'');
      document.getElementById('qText').textContent = q;
      // ë³´ê¸° ìƒì„±
      const field = (quizMode==='hanzi2meaning') ? 'meaning' : 'hanzi';
      const pool = cards.map(x=>x[field]).filter(Boolean);
      for(let i=pool.length-1;i>0;i--){ const j=(Math.random()*(i+1)|0); [pool[i],pool[j]]=[pool[j],pool[i]]; }
      const opts = new Set([quizAnswer]);
      for(const v of pool){ if(opts.size>=4) break; if(v!==quizAnswer) opts.add(v); }
      const arr = [...opts]; for(let i=arr.length-1;i>0;i--){ const j=(Math.random()*(i+1)|0); [arr[i],arr[j]]=[arr[j],arr[i]]; }
      const cont = document.getElementById('mcOptions'); cont.innerHTML='';
      arr.forEach(t=>{ const b=document.createElement('button'); b.className='opt'; b.textContent=t; b.onclick=()=>grade(t); cont.appendChild(b); });
      // íƒ€ì´ë¨¸ 5ì´ˆ
      remain=5; document.getElementById('quizTimer').textContent=remain;
      timerId = setInterval(()=>{ remain--; document.getElementById('quizTimer').textContent=remain; if(remain<=0){ grade(null,true); } },1000);
    }

    function grade(choice, timeout=false){
      clearTimer();
      const s=getScore(); s.attempts++;
      const ok = (!timeout && choice===quizAnswer);
      if(ok) s.correct++;
      setScore(s); updateHeaderStat();
      // í”¼ë“œë°± íš¨ê³¼ + ë‹¤ìŒ ë¬¸ì œ ì§„í–‰
      flash(ok? 'ok':'bad');
      if(ok) playDing();
      // ë‹¤ìŒ ì¹´ë“œë¡œ ì´ë™ í›„ ë‹¤ìŒ ë¬¸ì œ
      setTimeout(()=>{ next(); nextQuiz(); }, 650);
    }

    function flash(kind){
      const el=document.body; const cls=(kind==='ok')?'ok':'bad';
      el.classList.add(cls); setTimeout(()=>el.classList.remove(cls),220);
    }

    function clearTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }
    function closeQuiz(){ clearTimer(); quizModal.close(); }

    // ===== TTS =====
    function speakZh(text){ if(!('speechSynthesis' in window)||!text) return; const u=new SpeechSynthesisUtterance(text); u.lang='zh-CN'; u.rate=1; u.pitch=1; try{ speechSynthesis.cancel(); setTimeout(()=>speechSynthesis.speak(u),0);}catch(e){} }

    // ===== íš¨ê³¼ìŒ =====
    function playDing(){ const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return; const ctx=new AC(); const now=ctx.currentTime; const o1=ctx.createOscillator(), g1=ctx.createGain(); o1.type='sine'; o1.frequency.setValueAtTime(880,now); g1.gain.setValueAtTime(0.0001,now); g1.gain.exponentialRampToValueAtTime(0.25,now+0.01); g1.gain.exponentialRampToValueAtTime(0.0001,now+0.23); o1.connect(g1).connect(ctx.destination); o1.start(now); o1.stop(now+0.24); const o2=ctx.createOscillator(), g2=ctx.createGain(); o2.type='sine'; o2.frequency.setValueAtTime(660,now+0.26); g2.gain.setValueAtTime(0.0001,now+0.26); g2.gain.exponentialRampToValueAtTime(0.22,now+0.27); g2.gain.exponentialRampToValueAtTime(0.0001,now+0.52); o2.connect(g2).connect(ctx.destination); o2.start(now+0.26); o2.stop(now+0.53); }

    // ===== ì´ë²¤íŠ¸ =====
    document.getElementById('speakWord').onclick=()=>{ const c=current(); if(c) speakZh(c.hanzi); };
    document.getElementById('speakExample').onclick=()=>{ const c=current(); if(c) speakZh(c.example||c.hanzi); };
    document.getElementById('revealBtn').onclick=()=>{ meaning.style.display='block'; example.style.display='block'; };

    document.getElementById('nextBtn').onclick=next; document.getElementById('prevBtn').onclick=prev; document.getElementById('syncBtn').onclick=sync; document.getElementById('quizBtn').onclick=startQuiz;
    document.getElementById('quizExit').onclick=closeQuiz; document.getElementById('quizSkip').onclick=()=>{ next(); nextQuiz(); };

    // ì´ˆê¸° í‘œì‹œ
    render();
  </script>
</body>
</html>
